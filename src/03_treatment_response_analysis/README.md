# Treatment Response Analysis

Longitudinal analysis of PACC (Preclinical Alzheimer's Cognitive Composite) trajectories in response to Solanezumab treatment, stratified by AD tau-PET subtype (W1 / W2).

---

## Overview

This module fits a **Generalized Additive Mixed Model (GAMM)** with **natural cubic splines**, **participant-level random intercepts**, and **CAR(1) within-subject correlation** to assess differential treatment effects across Alzheimer's disease subtypes. The approach follows the methodology described in Carolyn et al.

**Primary hypothesis:** The therapeutic effect of Solanezumab on cognitive decline rates (slopes over time) is contingent upon baseline tau-PET subtype — i.e., whether W1 and W2 subtypes respond differently to treatment.

**Key questions:**
- Do W1 and W2 subtypes show different rates of cognitive decline over time?
- Does Solanezumab differentially benefit one subtype over the other?

---

## Model Specification

```
PACC ~ ns(T_weeks, df=3) × Group + age + sex + education + race + APOE-ε4 + amyloid + baseline_PACC
       + random intercept (person_id)
```

Where `Group = interaction(Subtype, Treatment)`, encoding all constituent two-way interactions (time-by-treatment, time-by-subtype, treatment-by-subtype) and the primary three-way interaction (time × treatment × subtype).

| Component | Choice | Rationale |
|-----------|--------|-----------|
| Time function | Natural cubic splines, df = 3 | Captures non-linear trajectories; df selected via two-stage validation (AIC + 10-fold CV) |
| Fixed effects | Hierarchically specified; all two-way interactions + three-way time × treatment × subtype | Tests whether solanezumab's effect on decline rate differs between W1 and W2 |
| Random effects | Participant-level random intercepts | Accounts for repeated measures nested within subjects |
| Correlation | CAR(1) | Continuous-time AR(1) for unequally spaced visits |
| Covariates | Age, sex, education, race, APOE-ε4, baseline amyloid (SUVRCER), baseline PACC | Standard AD trial adjustment set |

---

## Spline Degree Selection: Two-Stage Validation

df = 3 was selected through a two-stage process:

**Stage 1 — AIC comparison:** Models with df = 2, 3, 4 were fit using the same GLS framework. AIC favored df = 3.

**Stage 2 — 10-fold cross-validation:** Models with df = 1 through df = 4 were compared using out-of-sample R². Patients were held out as whole clusters (not individual observations) to prevent data leakage from within-subject correlation. Predictive performance plateaued at df = 3; higher df showed diminishing returns. df = 3 also ensures analytical consistency with the primary A4 trial analysis (Carolyn et al.), which used the same configuration.

---

## File Structure

```
03_treatment_response_analysis/
├── gls_treatment_response.R   # Main analysis script
└── README.md

# Required data (not tracked by git — see Data section below):
data/
├── PACC.csv
├── SUBJINFO.csv
└── Brainplotk=2.csv

# Outputs (generated by script):
outputs/
├── figures/
│   ├── PACC_gls_natural_spline.png
│   ├── PACC_gls_df3_CI.png
│   ├── PACC_gls_df4_CI.png
│   ├── PACC_gls_df3_PredictionInterval.png
│   ├── PACC_gls_bootstrap_CI.png
│   └── PACC_gls_bootstrap_CI_publication.pdf
│   ├── supplementary_histogram_visits.pdf
│   └── supplementary_histogram_visits.png
└── boot_summary.rds
```

---

## Data

Raw data files are **not included** in this repository (participant-level clinical trial data, access-restricted).

Required files and expected columns:

| File | Key columns |
|------|-------------|
| `PACC.csv` | `BID`, `VISCODE`, `PACC` |
| `SUBJINFO.csv` | `BID`, `TX`, `AGEYR`, `SEX`, `EDCCNTU`, `RACE`, `SUVRCER`, `AMYLCENT`, `APOEGN`, `APOEGNPRSNFLG` |
| `Brainplotk=2.csv` | `SubjectID`, `Subtype` (values: `S1`, `S2`) |

---

## Requirements

```r
install.packages(c("dplyr", "tidyr", "nlme", "splines", "mgcv",
                   "ggplot2", "ggthemes", "patchwork", "cowplot", "boot"))
```

R version ≥ 4.1.0 recommended.

---

## How to Run

1. Place the three data files in `data/` at the repo root.
2. Open `gls_treatment_response.R` and confirm the relative paths at the top match your directory layout.
3. Source the script:

```r
source("src/03_treatment_response_analysis/gls_treatment_response.R")
```

Figures are saved to `outputs/figures/`. The bootstrap step (n = 5,000) takes approximately 30–60 minutes depending on your machine.

---

## Output Description

| Figure | Description |
|--------|-------------|
| `PACC_gls_natural_spline.png` | Model trajectories, no uncertainty band |
| `PACC_gls_df3_CI.png` | df = 3 with delta-method 95% CI |
| `PACC_gls_df4_CI.png` | df = 4 with delta-method 95% CI (for comparison) |
| `PACC_gls_df3_PredictionInterval.png` | df = 3 with 95% prediction interval (includes residual variance; covers individual observations) |
| `PACC_gls_bootstrap_CI_publication.pdf` | Publication-ready Figure 6: bootstrap CI, W1 and W2 side by side |
| `supplementary_histogram_visits.pdf/.png` | Supplementary histogram of PACC assessment counts per participant (median 13, range 2–18) |

---

## Notes

- Bootstrap uses **cluster resampling** (whole patients resampled with replacement) to preserve the within-subject CAR(1) correlation structure. Resampling individual observations would underestimate uncertainty.
- Failed bootstrap iterations (non-convergence) are silently skipped; convergence rate per group is reported in console output. Results are saved to `outputs/boot_summary.rds` to avoid re-running.
- **Note on naming:** The internal variable `Subtype` uses values `S1`/`S2` (from the clustering output). These correspond to `W1`/`W2` as reported in the paper.
- Predictions are computed at covariate means (marginal effect): age, education, amyloid, and baseline PACC at sample means; sex = female; race = modal category; APOE4 = non-carrier.
